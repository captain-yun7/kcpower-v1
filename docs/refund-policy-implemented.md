# 환불 정책 구현 완료

## 구현된 정책

### 사용자 환불 신청 (프론트엔드 + 백엔드)
**제한 사항: 7일 + 진도율 10%**

- **7일 제한**: 결제일로부터 7일 이내만 환불 신청 가능
- **진도율 10% 제한**: 강의 진도율이 10% 미만인 경우만 환불 신청 가능
- 두 조건을 **모두** 만족해야 환불 신청 가능

### 관리자 환불 승인 (백엔드)
**제한 사항: 1년 (TossPayments API 제한)**

- **1년 제한**: 결제일로부터 1년 이내만 자동 환불 가능
- 7일 또는 10% 제한을 넘어도 관리자 재량으로 승인 가능
- 1년 경과 시 TossPayments API로 자동 취소 불가 → 수동 환불 안내

---

## 구현 파일

### 1. 사용자 환불 신청 API
**파일**: [src/app/api/refunds/route.ts](../src/app/api/refunds/route.ts)

**변경 사항**:
- 7일 제한 검사 추가
- 진도율 10% 검사 추가
- 상세 에러 메시지 반환 (날짜, 진도율 포함)

**에러 응답 예시**:
```json
{
  "error": "환불 신청 기간이 지났습니다",
  "detail": "결제일로부터 7일 이내에만 환불 신청이 가능합니다",
  "paymentDate": "2025-10-14T12:00:00.000Z",
  "daysElapsed": 8
}
```

```json
{
  "error": "환불 신청이 불가능합니다",
  "detail": "진도율 10% 미만인 경우에만 환불 가능합니다",
  "currentProgress": 15.5,
  "maxProgress": 10
}
```

---

### 2. 관리자 환불 승인 API
**파일**: [src/app/api/admin/refunds/[id]/approve/route.ts](../src/app/api/admin/refunds/[id]/approve/route.ts)

**변경 사항**:
- 1년 경과 여부 확인 추가 (TossPayments API 제한)
- 1년 경과 시 수동 환불 안내 메시지 반환
- 7일/10% 제한은 **검사하지 않음** (관리자 재량)

**1년 경과 시 응답 예시**:
```json
{
  "success": false,
  "requireManualRefund": true,
  "error": "자동 환불이 불가능합니다",
  "detail": "결제일로부터 1년이 경과하여 TossPayments API로 자동 취소가 불가능합니다.",
  "instruction": "관리자가 직접 고객 계좌로 환불 처리해주세요.",
  "refundInfo": {
    "amount": 99000,
    "userName": "홍길동",
    "userEmail": "user@example.com",
    "accountInfo": "신한은행 110-123-456789 (홍길동)"
  },
  "paymentDate": "2024-10-21T12:00:00.000Z",
  "yearsElapsed": 1.02
}
```

---

### 3. 사용자 환불 신청 페이지
**파일**: [src/app/refunds/request/[purchaseId]/page.tsx](../src/app/refunds/request/[purchaseId]/page.tsx)

**변경 사항**:
- 환불 정책 안내 문구 업데이트 (7일 + 10% 명시)
- 상세 에러 메시지 표시 (날짜, 진도율 포함)
- 멀티라인 에러 메시지 지원 (`whitespace-pre-line`)

**UI 변경**:
```
환불 정책 안내
- 환불 가능 조건: 결제일로부터 7일 이내 + 진도율 10% 미만
- 환불 신청 후 관리자 승인까지 1-2 영업일이 소요됩니다
- 카드 결제: 카드사를 통해 자동 환불 처리됩니다 (3-7일 소요)
- 무통장입금: 입력하신 계좌로 환불금이 입금됩니다 (1-2일 소요)
- 환불 승인 후 수강 등록이 자동으로 취소되며, 강의를 수강할 수 없습니다
- 특별한 사유가 있는 경우 관리자 재량으로 7일 이후에도 환불이 승인될 수 있습니다
```

---

## 환불 정책 시나리오

### 시나리오 1: 정상 환불 (7일 이내 + 진도율 5%)
```
사용자: 결제 후 3일 경과, 진도율 5%
→ ✅ 환불 신청 가능
→ ✅ 관리자 승인 가능 (자동 환불)
```

### 시나리오 2: 7일 경과 (진도율 5%)
```
사용자: 결제 후 10일 경과, 진도율 5%
→ ❌ 환불 신청 불가 (7일 제한)
→ 에러: "환불 신청 기간이 지났습니다"

관리자: 특별 사유로 직접 승인 결정
→ ✅ 관리자 승인 가능 (10일 < 1년)
→ ✅ TossPayments API로 자동 환불
```

### 시나리오 3: 진도율 15% (5일 경과)
```
사용자: 결제 후 5일 경과, 진도율 15%
→ ❌ 환불 신청 불가 (진도율 10% 초과)
→ 에러: "진도율 15.0%로 환불이 불가능합니다"

관리자: 특별 사유로 직접 승인 결정
→ ✅ 관리자 승인 가능 (5일 < 1년)
→ ✅ TossPayments API로 자동 환불
```

### 시나리오 4: 1년 경과 (진도율 5%)
```
사용자: 결제 후 400일 경과, 진도율 5%
→ ❌ 환불 신청 불가 (7일 제한)

관리자: 특별 사유로 직접 승인 결정
→ ❌ 자동 환불 불가 (1년 경과)
→ ⚠️ 수동 환불 안내 메시지 표시
→ 관리자가 직접 고객 계좌로 입금 필요
```

---

## 정책 요약표

| 경과 시간 | 진도율 | 사용자 신청 | 관리자 승인 (자동) | 관리자 승인 (수동) |
|---------|-------|-----------|-----------------|-----------------|
| 3일     | 5%    | ✅        | ✅              | -               |
| 10일    | 5%    | ❌        | ✅              | -               |
| 5일     | 15%   | ❌        | ✅              | -               |
| 400일   | 5%    | ❌        | ❌              | ⚠️ 수동 처리    |

---

## 장점

### 사용자 측면
- **명확한 정책**: 7일 + 10% 제한으로 간단명료
- **공정한 규칙**: 악용 방지 (강의 다 보고 환불 불가)
- **유연성**: 특별 사유 시 관리자 재량으로 승인 가능

### 관리자 측면
- **자동화**: 7일/10% 검사 자동화로 관리 효율 증가
- **재량권**: 7일 넘어도 1년 이내 승인 가능
- **API 안전**: 1년 경과 시 TossPayments API 에러 방지
- **수동 처리 안내**: 1년 경과 시 명확한 가이드 제공

### 시스템 측면
- **에러 방지**: TossPayments API 1년 제한 준수
- **상세 로깅**: 날짜, 진도율 정보 포함
- **확장 가능**: 정책 변경 시 수정 용이

---

## 비교: 다른 플랫폼

| 플랫폼 | 시간 제한 | 진도율 제한 | 특이사항 |
|-------|---------|----------|---------|
| **우리 LMS** | 7일 | 10% | 관리자 재량 1년까지 |
| 인프런 | 7일 | 10% | - |
| 패스트캠퍼스 | 7일 | 강의 시작 전 | - |
| 유데미 | 30일 | 제한 없음 | - |
| 클래스101 | 7일 | 30% | - |

우리 정책은 **인프런과 동일**하며, **관리자 재량**을 추가로 허용합니다.

---

## 테스트 방법

### 1. 7일 제한 테스트
```sql
-- 결제 날짜를 10일 전으로 변경
UPDATE Purchase
SET createdAt = NOW() - INTERVAL 10 DAY
WHERE id = 'purchase-id';
```

환불 신청 시 에러:
```
환불 신청 기간이 지났습니다

결제일: 2025-10-11
경과일: 10일

환불 정책: 결제일로부터 7일 이내만 환불 가능합니다.
```

### 2. 진도율 10% 제한 테스트
```sql
-- 강의 총 10개 영상 중 2개 완료로 변경 (20%)
-- Progress 테이블에서 isCompleted = true 개수 조정
```

환불 신청 시 에러:
```
환불 신청이 불가능합니다

현재 진도율: 20.0%
허용 진도율: 10% 미만

환불 정책: 진도율 10% 미만인 경우에만 환불 가능합니다.
```

### 3. 1년 제한 테스트 (관리자)
```sql
-- 결제 날짜를 400일 전으로 변경
UPDATE Payment
SET paidAt = NOW() - INTERVAL 400 DAY
WHERE id = 'payment-id';
```

관리자 승인 시 에러:
```
자동 환불이 불가능합니다

결제일로부터 1년이 경과하여 TossPayments API로 자동 취소가 불가능합니다.

관리자가 직접 고객 계좌로 환불 처리해주세요.

환불 정보:
- 금액: 99000원
- 사용자: 홍길동 (user@example.com)
- 계좌: 신한은행 110-123-456789 (홍길동)
```

---

## 추가 개선 아이디어 (선택사항)

### 1. 이메일 알림
- 환불 신청 시 관리자에게 알림
- 환불 승인/거절 시 사용자에게 알림

### 2. 관리자 대시보드 개선
- 7일/10% 제한으로 자동 거절된 신청 통계
- 관리자 재량으로 승인한 환불 통계

### 3. 사용자 대시보드
- 환불 신청 전 현재 진도율 표시
- 환불 가능 기간 D-day 표시

---

## 결론

✅ **구현 완료**
- 사용자: 7일 + 10% 제한
- 관리자: 1년 제한 (재량권 보유)
- TossPayments API 안전성 확보
- 상세 에러 메시지 제공

이 정책은 **공정성**, **자동화**, **유연성**을 모두 만족합니다.
